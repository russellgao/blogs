<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>istio中的ELK实践 - 大大很二的博客</title><meta name="Description" content="投稿到 servicemesh 社区的文章"><meta property="og:title" content="istio中的ELK实践" />
<meta property="og:description" content="投稿到 servicemesh 社区的文章" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://russellgao.cn/opensrouce/elk/" />
<meta property="og:image" content="https://russellgao.cn/images/site-feature-imagea.png"/>
<meta property="article:published_time" content="2020-11-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-10T22:58:03+08:00" /><meta property="og:site_name" content="大大很二的博客" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://russellgao.cn/images/site-feature-imagea.png"/>

<meta name="twitter:title" content="istio中的ELK实践"/>
<meta name="twitter:description" content="投稿到 servicemesh 社区的文章"/>
<meta name="application-name" content="russellgao">
<meta name="apple-mobile-web-app-title" content="russellgao"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://russellgao.cn/opensrouce/elk/" /><link rel="prev" href="https://russellgao.cn/opensrouce/myself/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "istio中的ELK实践",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/russellgao.cn\/opensrouce\/elk\/"
        },"genre": "opensrouce","keywords": "kubernetes, istio","wordcount":  852 ,
        "url": "https:\/\/russellgao.cn\/opensrouce\/elk\/","datePublished": "2020-11-10T00:00:00+00:00","dateModified": "2020-11-10T22:58:03+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "russellgao"
            },"description": "投稿到 servicemesh 社区的文章"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="大大很二的博客"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png"
        data-srcset="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png, https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png 1.5x, https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png"
        title="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png" />大大很二</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> 首页 </a><a class="menu-item" href="/golang/"> Golang </a><a class="menu-item" href="/kubernetes/"> Kubernetes </a><a class="menu-item" href="/servicemesh/"> ServiceMesh </a><a class="menu-item" href="/python/"> Python </a><a class="menu-item" href="/devops/"> Devops </a><a class="menu-item" href="/argorithm/"> 算法 </a><a class="menu-item" href="/opensrouce/"> 开源项目 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="大大很二的博客"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png"
        data-srcset="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png, https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png 1.5x, https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png"
        title="https://gitee.com/russellgao/blogs-image/raw/master/images/russellgao.png" />大大很二</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/" title="">首页</a><a class="menu-item" href="/golang/" title="">Golang</a><a class="menu-item" href="/kubernetes/" title="">Kubernetes</a><a class="menu-item" href="/servicemesh/" title="">ServiceMesh</a><a class="menu-item" href="/python/" title="">Python</a><a class="menu-item" href="/devops/" title="">Devops</a><a class="menu-item" href="/argorithm/" title="">算法</a><a class="menu-item" href="/opensrouce/" title="">开源项目</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="page single special"><h1 class="single-title animated pulse faster">istio中的ELK实践</h1><div class="content" id="content"><h1 id="elk">ELK</h1>
<blockquote>
<p>这篇文档是由我投稿的云原生社区的文章，节选自 <a href="https://www.servicemesher.com/istio-handbook/" target="_blank" rel="noopener noreffer">istio-handbook</a>，如果有兴趣可以参考这本书。</p>
</blockquote>
<p>ELK 指的是由 Elasticsearch + Logstash + Kibana 组成的日志采集、存储、展示为一体的日志解决方案，简称 &ldquo;ELK Stack&rdquo;。ELK Stack 还包含 Beats（如Filebeat、Metricbeat、Heartbeat等）、Kafka等成员，是目前主流的一种日志解决方案。</p>
<ul>
<li>
<p>Elasticsearch 是个开源分布式搜索引擎，提供搜集、分析、存储数据三大功能。</p>
</li>
<li>
<p>Logstash 是免费且开放的服务器端数据处理管道，能够从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的“存储库”中。Logstash 比较耗资源，在实践中我们一般用作实时解析和转换数据。Logstash 采用可插拔框架，拥有 200 多个插件。您可以将不同的输入选择、过滤器和输出选择混合搭配、精心安排，让它们在管道中和谐地运行。</p>
</li>
<li>
<p>Kibana 是一个开源和免费的工具，Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助汇总、分析和搜索重要数据日志。</p>
</li>
<li>
<p>Kafka 是由 Apache 软件基金会开发的一个开源流处理平台，由 Scala 和 Java 编写。用来做缓冲，当日志量比较大的时候可以缓解后端 Elasticsearch 的压力。</p>
</li>
<li>
<p>Beats 是数据采集的得力工具。Beats家族成员包括如下：</p>
<ul>
<li>Filebeat：用于日志文件采集，内置了多种模块（Apache、Cisco ASA、Microsoft Azure、NGINX、MySQL 等等）。</li>
<li>Metricbeat： 用于指标采集。</li>
<li>Packetbeat：用于网络数据采集。</li>
<li>Winlogbeat：用于Windows 事件采集。</li>
<li>Auditbeat：用于审计日志采集。</li>
<li>Heartbeat：用于运行时间采集。</li>
</ul>
<p><strong>其中 Filebeat 被经常用来收集 Node 或者 Pod 中的日志</strong>。</p>
</li>
</ul>
<p>Beats 用于收集客户端的日志，发送给缓存队列如Kafka，目的是为了解耦数据收集与解析入库的过程，同时提高了可扩展性，使日志系统有峰值处理能力，不会因为突发的访问压力造成日志系统奔溃。缓存队列可选的还有 Redis，由于 Redis 是内存型，很容易写满，生产环境建议用 kafka。Logstash 从 缓存队列中消费日志解析处理之后写到 Elasticsearch，通过 Kibana 展示给最终用户。</p>
<h2 id="采集方案">采集方案</h2>
<p>Filebeat 有两种部署模式，一是通过 DaemonSet 方式部署，二是通过 Sidecar 方式部署，Filebeat 采集后发送到 Kafka ，再由 Logstash 从 Kafka 中消费写到 Elasticsearch。</p>
<h3 id="daemonset-方式部署">DaemonSet 方式部署</h3>
<p>开启 Envoy 的访问日志输出到 <code>stdout</code> ，以 DaemonSet 的方式在每一台集群节点部署 Filebeat ，并将日志目录挂载至 Filebeat Pod，实现对 Envoy 访问日志的采集。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-daemonset.png"
        data-srcset="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-daemonset.png, https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-daemonset.png 1.5x, https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-daemonset.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-daemonset.png"
        title="ELK 日志收集架构 DeamonSet" /></p>
<h3 id="sidecar-方式部署">Sidecar 方式部署</h3>
<p>Filebeat 和 Envoy 部署在同一个 Pod 内，共享日志数据卷， Envoy 写，Filebeat 读，实现对 Envoy 访问日志的采集。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-sidecar.png"
        data-srcset="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-sidecar.png, https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-sidecar.png 1.5x, https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-sidecar.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-filebeat-sidecar.png"
        title="ELK 日志收集架构 Sidecar" /></p>
<h2 id="部署-elk">部署 ELK</h2>
<p>有了以上的基础，我们开始部署 <code>ELK Stack</code></p>
<h3 id="部署-kafka">部署 Kafka</h3>
<p>首先，创建一个新的 namespace 用于部署 <code>ELK Stack</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># Logging Namespace. All below are a part of this namespace.
apiVersion: v1
kind: Namespace
metadata:
  name: logging
</code></pre></td></tr></table>
</div>
</div><p>接下来，部署 Kafka 服务。 Kafka 通过 Zookeeper 管理集群配置，所以在部署 Kafka 需要先部署 Zookeeper。</p>
<p>Zookeeper 是一个分布式的，开放源码的分布式应用程序协调服务。</p>
<p>Kafka 与 Zookeeper 都是有状态服务，部署时需要选择 <code>StatefulSet</code> 。</p>
<ol>
<li>
<p>部署 Zookeeper Service</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>zookeeper-cluster<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>zookeeper-cluster<span class="w">
</span><span class="w">  </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>http<span class="w">
</span><span class="w">      </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">2181</span><span class="w">
</span><span class="w">      </span><span class="k">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">2181</span><span class="w">
</span><span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>ClusterIP<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Zookeeper 在集群内使用，供 Kafka 使用，创建类型为 ClusterIP 的 Service 。</li>
<li>Zookeeper 的默认端口是<code>2181</code>。</li>
</ul>
</li>
<li>
<p>部署 Zookeeper ConfigMap</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ConfigMap<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>zookeeper-config<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">ZOO_CONF_DIR</span><span class="p">:</span><span class="w"> </span>/conf<span class="w">
</span><span class="w">  </span><span class="k">ZOO_PORT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2181&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Zookeeper 配置文件中的 key 都可以 以 <code>ZOO_</code> 加大写的方式设置到环境变量中，使之生效。</li>
<li>这里仅列举部分配置。</li>
</ul>
</li>
<li>
<p>部署 Zookeeper StatefulSet</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>StatefulSet<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>zookeeper<span class="w">
</span><span class="w"> </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="k">serviceName</span><span class="p">:</span><span class="w"> </span>zookeeper-cluster<span class="w">
</span><span class="w"> </span><span class="k">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w"> </span><span class="k">updateStrategy</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>RollingUpdate<span class="w">
</span><span class="w"> </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>zookeeper-cluster<span class="w">
</span><span class="w"> </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">       </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>zookeeper-cluster<span class="w">
</span><span class="w">     </span><span class="k">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">       </span><span class="k">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">   </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">       </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>zookeeper<span class="w">
</span><span class="w">         </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span>10m<span class="w">
</span><span class="w">             </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>100Mi<span class="w">
</span><span class="w">           </span><span class="k">limits</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>200Mi<span class="w">
</span><span class="w">         </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>zookeeper<span class="w">
</span><span class="w">         </span><span class="k">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>IfNotPresent<span class="w">
</span><span class="w">         </span><span class="k">envFrom</span><span class="p">:</span><span class="w">
</span><span class="w">           </span>- <span class="k">configMapRef</span><span class="p">:</span><span class="w">
</span><span class="w">               </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>zookeeper-config<span class="w">
</span><span class="w">         </span><span class="k">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="k">tcpSocket</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">2181</span><span class="w">
</span><span class="w">           </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">           </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">         </span><span class="k">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="k">tcpSocket</span><span class="p">:</span><span class="w">
</span><span class="w">             </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">2181</span><span class="w">
</span><span class="w">           </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span><span class="w">           </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span><span class="w">         </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">           </span>- <span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">2181</span><span class="w">
</span><span class="w">             </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>zk-client<span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<ul>
<li>sidecar.istio.io/inject=false 标识此服务无需 sidecar 注入。</li>
</ul>
<ol start="4">
<li>
<p>部署 Kafka Service</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>bootstrap-kafka<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">clusterIP</span><span class="p">:</span><span class="w"> </span>None<span class="w">
</span><span class="w">  </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">9092</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>kafka<span class="w">
</span><span class="w">   
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>kafka-cluster<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>http<span class="w">
</span><span class="w">    </span><span class="k">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9092</span><span class="w">
</span><span class="w">    </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">9092</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>kafka<span class="w">
</span><span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>ClusterIP<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>部署两个 Service 。
<ul>
<li>bootstrap-kafka 为后续部署 Kafka Statefulset 使用。</li>
<li>kafka-cluster 为 Kafka 的访问入口，在生产中使用可以用其他的 Service 类型。</li>
<li>kafka 的默认端口是<code>9092</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>部署 Kafka ConfigMap</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ConfigMap<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>kafka-config<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">KAFKA_ADVERTISED_LISTENERS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;PLAINTEXT://kafka-cluster:9092&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">KAFKA_LISTENERS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;PLAINTEXT://0.0.0.0:9092&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">KAFKA_ZOOKEEPER_CONNECT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;zookeeper-cluster:2181&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">KAFKA_LOG_RETENTION_HOURS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;48&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">KAFKA_NUM_PARTITIONS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;30&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Kafka 配置文件（server.properties）中的 key 都可以 以 <code>KAFKA_</code> 加大写的方式设置到环境变量中，使之生效。</li>
<li>KAFKA_ADVERTISED_LISTENERS 为 Kafka 监听的服务地址。</li>
<li>KAFKA_ZOOKEEPER_CONNECT 为前面部署的 Zookeeper 的服务地址。</li>
<li>KAFKA_LOG_RETENTION_HOURS 为 Kafka 数据保留的时间，超过这个时间将会被清理，可以根据实际情况进行调整。</li>
<li>KAFKA_NUM_PARTITIONS 为创建 Kafka topic 时的默认分片数，设置大一些可以增加 Kafka 的吞吐量。</li>
<li>这里仅列举部分配置。</li>
</ul>
</li>
<li>
<p>部署 Kafka StatefulSet</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>StatefulSet<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>kafka<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>kafka<span class="w">
</span><span class="w">  </span><span class="k">serviceName</span><span class="p">:</span><span class="w"> </span>bootstrap-kafka<span class="w">
</span><span class="w">  </span><span class="k">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>kafka<span class="w">
</span><span class="w">      </span><span class="k">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">    </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>kafka-broker<span class="w">
</span><span class="w">        </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>russellgao/kafka<span class="p">:</span><span class="m">2.12-2.0.1</span><span class="w">
</span><span class="w">        </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>inside<span class="w">
</span><span class="w">          </span><span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9092</span><span class="w">
</span><span class="w">        </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="m">0.1</span><span class="w">
</span><span class="w">            </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>1024Mi<span class="w">
</span><span class="w">          </span><span class="k">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>3069Mi<span class="w">
</span><span class="w">        </span><span class="k">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">tcpSocket</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">9092</span><span class="w">
</span><span class="w">          </span><span class="k">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">        </span><span class="k">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">tcpSocket</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">9092</span><span class="w">
</span><span class="w">          </span><span class="k">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span><span class="w">          </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span><span class="w">        </span><span class="k">envFrom</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">configMapRef</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>kafka-config<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>kafka 对磁盘的 IO 要求较高，可以选择固态硬盘或者经过IO优化的磁盘，否则可能会成为日志系统的瓶颈。</li>
</ul>
</li>
</ol>
<p>请注意，本次实践没有把数据卷映射出来，在生产实践中使用 <code>volumeClaimTemplates</code> 来为 Pod 提供持久化存储。<code>resources</code> 可以根据实际情况调整。</p>
<h3 id="部署-logstash">部署 Logstash</h3>
<p>Logstash 是一个无状态服务，通过 Deployment 进行部署。</p>
<ol>
<li>
<p>部署 Logstash ConfigMap</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ConfigMap<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>logstash-conf<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">logstash.conf</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">    input {</span><span class="w">
</span><span class="w">        </span>http<span class="w"> </span>{<span class="w">
</span><span class="w">            </span>host<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;0.0.0.0&#34;</span><span class="w"> </span><span class="c"># default: 0.0.0.0</span><span class="w">
</span><span class="w">            </span><span class="k">port =&gt; 8080 # default</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">            </span>user<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;logstash&#34;</span><span class="w">
</span><span class="w">            </span>password<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;aoDJ0JVgkfNPjarn&#34;</span><span class="w">
</span><span class="w">            </span>response_headers<span class="w"> </span>=&gt;<span class="w"> </span>{<span class="w">
</span><span class="w">                </span><span class="s2">&#34;Content-Type&#34;</span><span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;text/plain&#34;</span><span class="w">
</span><span class="w">                </span><span class="s2">&#34;Access-Control-Allow-Origin&#34;</span><span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">                </span><span class="s2">&#34;Access-Control-Allow-Methods&#34;</span><span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;GET, POST, DELETE, PUT&#34;</span><span class="w">
</span><span class="w">                </span><span class="s2">&#34;Access-Control-Allow-Headers&#34;</span><span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;authorization, content-type&#34;</span><span class="w">
</span><span class="w">                </span><span class="s2">&#34;Access-Control-Allow-Credentials&#34;</span><span class="w"> </span>=&gt;<span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">            </span>}<span class="w">
</span><span class="w">        </span>}<span class="w">
</span><span class="w">        </span>kafka<span class="w">  </span>{<span class="w">
</span><span class="w">            </span>topics<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;istio&#34;</span><span class="w">
</span><span class="w">            </span>bootstrap_servers<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;kafka-cluster:9092&#34;</span><span class="w">
</span><span class="w">            </span>auto_offset_reset<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;earliest&#34;</span><span class="w">
</span><span class="w">            </span>group_id<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;istio_kafka_gr&#34;</span><span class="w">
</span><span class="w">            </span>consumer_threads<span class="w"> </span>=&gt;<span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">            </span>codec<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;json&#34;</span><span class="w">
</span><span class="w">        </span>}<span class="w">
</span><span class="w">    </span>}<span class="w">
</span><span class="w">    </span>filter<span class="w"> </span>{<span class="w">
</span><span class="w">      </span>grok<span class="w"> </span>{<span class="w">
</span><span class="w">            </span>match<span class="w"> </span>=&gt;<span class="w"> </span>{<span class="w"> </span><span class="s2">&#34;message&#34;</span><span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;(?m)\[%{TIMESTAMP_ISO8601:timestamp}\] &#34;</span>%{NOTSPACE<span class="p">:</span>method}<span class="w"> </span>%{NOTSPACE<span class="p">:</span>path}<span class="w"> </span>%{NOTSPACE<span class="p">:</span>protocol}<span class="s2">&#34; %{NUMBER:response_code:int} %{NOTSPACE:response_flags} &#34;</span>%{NOTSPACE<span class="p">:</span>istio_policy_status}<span class="s2">&#34; &#34;</span>%{NOTSPACE<span class="p">:</span>upstream_transport_failure_reason}<span class="s2">&#34; %{NUMBER:bytes_received:int} %{NUMBER:bytes_sent:int} %{NUMBER:duration:int} %{NUMBER:upstream_service_time:int} &#34;</span>%{NOTSPACE<span class="p">:</span>x_forwarded_for}<span class="s2">&#34; &#34;</span>%{NOTSPACE<span class="p">:</span>user_agent}<span class="s2">&#34; &#34;</span>%{NOTSPACE<span class="p">:</span>request_id}<span class="s2">&#34; &#34;</span>%{NOTSPACE<span class="p">:</span>authority}<span class="s2">&#34; &#34;</span>%{NOTSPACE<span class="p">:</span>upstream_host}<span class="s2">&#34; %{NOTSPACE:upstream_cluster} %{NOTSPACE:upstream_local_address} %{NOTSPACE:downstream_local_address} %{NOTSPACE:downstream_remote_address} %{NOTSPACE:requested_server_name} %{NOTSPACE:route_name}&#34;</span><span class="w"> </span>}<span class="w">
</span><span class="w">            </span>remove_field<span class="w"> </span>=&gt;<span class="w"> </span><span class="p">[</span><span class="s2">&#34;message&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">      </span>}<span class="w">
</span><span class="w">      </span>date<span class="w"> </span>{<span class="w">
</span><span class="w">            </span>match<span class="w"> </span>=&gt;<span class="w"> </span><span class="p">[</span><span class="s2">&#34;timestamp&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;yyyy-MM-ddTHH:mm:ss.SSSZ&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">            </span>timezone<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;Asia/Shanghai&#34;</span><span class="w">
</span><span class="w">      </span>}<span class="w">
</span><span class="w">      </span>ruby<span class="w"> </span>{<span class="w">
</span><span class="w">          </span>code<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;event.set(&#39;[@metadata][index_day]&#39;,(event.get(&#39;@timestamp&#39;).time.localtime + 8*60*60 ).strftime(&#39;%Y.%m.%d&#39;))&#34;</span><span class="w">
</span><span class="w">      </span>}<span class="w">
</span><span class="w">    </span>}<span class="w">
</span><span class="w">    </span>output<span class="w"> </span>{<span class="w">
</span><span class="w">        </span>if<span class="w"> </span><span class="s2">&#34;_grokparsefailure&#34;</span><span class="w"> </span>not<span class="w"> </span>in<span class="w"> </span><span class="p">[</span>tags<span class="p">]</span><span class="w"> </span>{<span class="w">
</span><span class="w">            </span>elasticsearch<span class="w"> </span>{<span class="w">
</span><span class="w">                </span>user<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;elastic&#34;</span><span class="w">
</span><span class="w">                </span>password<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;elastic&#34;</span><span class="w">
</span><span class="w">                </span>hosts<span class="w"> </span>=&gt;<span class="w"> </span><span class="p">[</span><span class="s2">&#34;elasticsearch.com:9200&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">                </span>index<span class="w"> </span>=&gt;<span class="w"> </span><span class="s2">&#34;istio-%{[@metadata][index_day]}&#34;</span><span class="w">
</span><span class="w">            </span>}<span class="w">
</span><span class="w">        </span>}<span class="w">
</span><span class="w">    </span>}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Logstash 配置由3部分组成：</p>
<p><strong>input</strong></p>
<ul>
<li>Logstash input 支持非常多的数据源，如 File、Elasticsearch、Beats、Redis、Kafka、Http等。</li>
<li>Http input 用于Logstash 的健康检查，也可通过 http 接口将日志直接发送到 Logstash，主要用于移动端的场景。</li>
<li>Kafka input 用于收集日志，一个input只能从一个 Topic 中读取数据，需要和后续的 Filebeat output 对应。</li>
</ul>
<p><strong>filter</strong></p>
<ul>
<li>Logstash filter 支持非常多的插件，可以对数据进行解析、加工、转换，如 grok、date、ruby、json、drop等。</li>
<li>grok 用于对日志进行解析。</li>
<li>date 用于把 <code>timestamp</code> 转化成 elasticsearch 中的 <code>@timestamp</code> 字段，可以指定时区。</li>
<li>ruby 插件支持执行 ruby 代码，可以进行复杂逻辑的处理，此处的用法是 <code>@timestamp</code> 字段的时间加8小时，解决自动生成的索引时差问题。</li>
</ul>
<p><strong>output</strong></p>
<ul>
<li>Logstash output 支持非常多的数据源，如 elasticsearch、cvs、jdbc 等。</li>
<li>此处是把 grok 解析成功的日志写到 elasticsearch 。</li>
</ul>
</li>
<li>
<p>部署 Logstash Deployment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>apps/v1beta2<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>logstash<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>logstash<span class="w">
</span><span class="w">  </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>logstash<span class="w">
</span><span class="w">      </span><span class="k">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">    </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>config<span class="w">
</span><span class="w">        </span><span class="k">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>logstash-conf<span class="w">
</span><span class="w">      </span><span class="k">hostname</span><span class="p">:</span><span class="w"> </span>logstash<span class="w">
</span><span class="w">      </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>logstash<span class="w">
</span><span class="w">          </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>logstash<span class="p">:</span><span class="m">7.2.0</span><span class="w">
</span><span class="w">          </span><span class="k">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="w">            </span><span class="s2">&#34;-f&#34;</span><span class="p">,</span><span class="s2">&#34;/usr/share/logstash/pipeline/logstash.conf&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">          </span><span class="p">]</span><span class="w">
</span><span class="w">          </span><span class="k">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>IfNotPresent<span class="w">
</span><span class="w">          </span><span class="k">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>config<span class="w">
</span><span class="w">            </span><span class="k">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/usr/share/logstash/pipeline/logstash.conf&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">            </span><span class="k">subPath</span><span class="p">:</span><span class="w"> </span>logstash.conf<span class="w">
</span><span class="w">          </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="m">0.5</span><span class="w">
</span><span class="w">              </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>1024Mi<span class="w">
</span><span class="w">            </span><span class="k">limits</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="m">1.5</span><span class="w">
</span><span class="w">              </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>3072Mi<span class="w">
</span><span class="w">          </span><span class="k">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">tcpSocket</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">            </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">            </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">          </span><span class="k">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">tcpSocket</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">            </span><span class="k">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span><span class="w">            </span><span class="k">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Logstash 不需要对外发布服务，即不需要创建 Service，从 Kafka 中消费日志，处理完成之后写到 Elasticsearch 。</li>
<li>Logstash 只需要把配置文件挂载进去，无需挂载其他目录，排查错误时可通过 Logstash Console Log 进行查看。</li>
</ul>
</li>
<li>
<p>部署 Logstash HorizontalPodAutoscaler</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>autoscaling/v2beta1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>HorizontalPodAutoscaler<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>logstash<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>apps/v1beta2<span class="w">
</span><span class="w">    </span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>logstash<span class="w">
</span><span class="w">  </span><span class="k">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span><span class="k">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">  </span><span class="k">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">type</span><span class="p">:</span><span class="w"> </span>Resource<span class="w">
</span><span class="w">    </span><span class="k">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>cpu<span class="w">
</span><span class="w">      </span><span class="k">targetAverageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Logstash 比较消费 CPU ，可以部署 HPA，可以根据日志量动态的扩所容。</li>
<li>Logstash 的压力对 CPU 比较敏感，可以只根据 CPU 这一个指标进行 HPA。</li>
</ul>
</li>
</ol>
<p>Logstash 的配置文件支持if/else条件判断，通过这种方式，一个 Logstash 集群可以支持比较多的日志格式。另外 Logstash 的 grok 语法相对复杂，可以使用 Kibana <code>Dev Tools</code> 工具进行调试，如下图：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-grok-debug.jpg"
        data-srcset="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-grok-debug.jpg, https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-grok-debug.jpg 1.5x, https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-grok-debug.jpg 2x"
        data-sizes="auto"
        alt="https://gitee.com/russellgao/blogs-image/raw/master/images/opensource/elk-grok-debug.jpg"
        title="ELK grok debug" /></p>
<h3 id="部署-filebeat">部署 Filebeat</h3>
<p>这里仅给出 Filebeat DaemonSet 的部署过程。</p>
<ol>
<li>
<p>部署 Filebeat ConfigMap</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ConfigMap<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>filebeat-conf<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w"></span><span class="k">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">filebeat.yml</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">    filebeat:</span><span class="w">
</span><span class="w">      </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="sd">-
</span><span class="sd">          paths:</span><span class="w">
</span><span class="w">            </span>- /var/log<span class="w">
</span><span class="w">            </span>- /var/lib/docker/containers<span class="w">
</span><span class="w">          </span><span class="k">ignore_older</span><span class="p">:</span><span class="w"> </span>1h<span class="w">
</span><span class="w">          </span><span class="k">force_close_files</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#强制filebeat在文件名改变时，关闭文件，会有丢失日志的风险</span><span class="w">
</span><span class="w">          </span><span class="k">close_older</span><span class="p">:</span><span class="w"> </span>1m<span class="w">
</span><span class="w">          </span><span class="k">fields_under_root</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="k">output</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">kafka</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">          </span><span class="k">hosts</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;kafka-cluster:9092&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">          </span><span class="k">topic</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;istio&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2.0.0&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">partition.round_robin</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">reachable_only</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">          </span><span class="k">worker</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">          </span><span class="k">max_retries</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">          </span><span class="k">bulk_max_size</span><span class="p">:</span><span class="w"> </span><span class="m">2048</span><span class="w">
</span><span class="w">          </span><span class="k">timeout</span><span class="p">:</span><span class="w"> </span>30s<span class="w">
</span><span class="w">          </span><span class="k">broker_timeout</span><span class="p">:</span><span class="w"> </span>10s<span class="w">
</span><span class="w">          </span><span class="k">channel_buffer_size</span><span class="p">:</span><span class="w"> </span><span class="m">256</span><span class="w">
</span><span class="w">          </span><span class="k">keep_alive</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">          </span><span class="k">compression</span><span class="p">:</span><span class="w"> </span>gzip<span class="w">
</span><span class="w">          </span><span class="k">max_message_bytes</span><span class="p">:</span><span class="w"> </span><span class="m">1000000</span><span class="w">
</span><span class="w">          </span><span class="k">required_acks</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>input.paths 代表 Filebeat 监听的日志路径。</li>
<li>input.ignore_older 代表日志文件的修改时间超过这个之间，将会忽略，这个在 Filebeat 重启时很有效果，解决重复读取日志的问题。</li>
<li>out.kafka.hosts 和之前部署的 Kafka Service 对应。</li>
<li>out.kafka.topic 和之前部署的 Logstash ConfigMap 中的 input 对应。</li>
</ul>
</li>
<li>
<p>部署 Filebeat DaemonSet</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w">  </span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>DaemonSet<span class="w">
</span><span class="w">  </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>filebeat<span class="w">
</span><span class="w">    </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>logging<span class="w">
</span><span class="w">    </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>filebeat<span class="w">
</span><span class="w">  </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>filebeat<span class="w">
</span><span class="w">    </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>filebeat<span class="w">
</span><span class="w">        </span><span class="k">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">      </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>filebeat<span class="w">
</span><span class="w">          </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>elastic/filebeat<span class="p">:</span><span class="m">7.2.0</span><span class="w">
</span><span class="w">          </span><span class="k">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>IfNotPresent<span class="w">
</span><span class="w">          </span><span class="k">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>config<span class="w">
</span><span class="w">            </span><span class="k">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/usr/share/filebeat/filebeat.yml&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">            </span><span class="k">subPath</span><span class="p">:</span><span class="w"> </span>filebeat.yml<span class="w">
</span><span class="w">            </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>varlog<span class="w">
</span><span class="w">              </span><span class="k">mountPath</span><span class="p">:</span><span class="w"> </span>/var/log<span class="w">
</span><span class="w">            </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>varlibdockercontainers<span class="w">
</span><span class="w">              </span><span class="k">mountPath</span><span class="p">:</span><span class="w"> </span>/var/lib/docker/containers<span class="w">
</span><span class="w">          </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="m">0.1</span><span class="w">
</span><span class="w">              </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>200Mi<span class="w">
</span><span class="w">            </span><span class="k">limits</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="m">0.3</span><span class="w">
</span><span class="w">              </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>600Mi<span class="w">
</span><span class="w">        </span><span class="k">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>varlog<span class="w">
</span><span class="w">          </span><span class="k">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/var/log<span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>varlibdockercontainers<span class="w">
</span><span class="w">          </span><span class="k">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/var/lib/docker/containers<span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>config<span class="w">
</span><span class="w">          </span><span class="k">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>filebeat-conf<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这里声明了两个 <code>hostPath</code> 类型的数据卷，路径为日志存储的路径。</li>
<li>将宿主机的 <code>/var/log</code> 和 <code>/var/lib/docker/containers</code> 挂载到了 Filebeat Pod 内便于 Filebeat 收集日志。</li>
<li>Filebeat 不需要部署 Service 。</li>
<li>Filebeat 对资源消耗比较少，可忽略对 Node 的资源消耗。</li>
</ul>
</li>
</ol>
<h2 id="小结">小结</h2>
<p>本节为大家介绍了 ELK 的原理和安装部署，以及如何收集日志。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://www.elastic.co/cn/beats/" target="_blank" rel="noopener noreffer">Beats</a></li>
<li><a href="https://www.elastic.co/logstash" target="_blank" rel="noopener noreffer">Logstash</a></li>
<li><a href="https://hub.docker.com/_/zookeeper" target="_blank" rel="noopener noreffer">Zookeeper</a></li>
</ul>
</div><div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></div></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.73.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/russellgao" target="_blank">高维宗(russellgao)</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2CElement.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script type="text/javascript" src="/lib/object-fit-images/ofi.min.js"></script><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"valine":{"appId":"UPHfC2syBI9Pu5vyncYfvYX5-9Nh9j0Va","appKey":"MBiG6UopXrWQR41mzt7jtq8o","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"serverURLs":"https://uphfc2sy.lc-cn-e1-shared.com","visitor":true}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
